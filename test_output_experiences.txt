============================= test session starts =============================
platform win32 -- Python 3.13.2, pytest-7.4.3, pluggy-1.6.0 -- C:\Users\jordi\AppData\Local\Programs\Python\Python313\python.exe
cachedir: .pytest_cache
django: version: 5.1.12, settings: refugis_lliures.settings (from ini)
rootdir: C:\Users\jordi\Desktop\UNI\TFG\Backend\RefugisLliures_Backend
configfile: pytest.ini
plugins: Faker-20.1.0, cov-4.1.0, django-4.7.0, mock-3.12.0
collecting ... collected 24 items

api/tests/experiences/test_controllers.py::TestExperienceController::test_get_experiences_by_refuge_success PASSED [  4%]
api/tests/experiences/test_controllers.py::TestExperienceController::test_create_experience_success PASSED [  8%]
api/tests/experiences/test_controllers.py::TestExperienceController::test_delete_experience_success PASSED [ 12%]
api/tests/experiences/test_daos.py::TestExperienceDAO::test_create_experience_success PASSED [ 16%]
api/tests/experiences/test_daos.py::TestExperienceDAO::test_get_experience_by_id_found PASSED [ 20%]
api/tests/experiences/test_daos.py::TestExperienceDAO::test_update_experience_success PASSED [ 25%]
api/tests/experiences/test_daos.py::TestExperienceDAO::test_update_experience_with_media_keys PASSED [ 29%]
api/tests/experiences/test_daos.py::TestExperienceDAO::test_delete_experience_success FAILED [ 33%]
api/tests/experiences/test_daos.py::TestExperienceDAO::test_remove_media_key_success PASSED [ 37%]
api/tests/experiences/test_mappers.py::TestExperienceMapper::test_firestore_to_model PASSED [ 41%]
api/tests/experiences/test_mappers.py::TestExperienceMapper::test_model_to_firestore PASSED [ 45%]
api/tests/experiences/test_mappers.py::TestExperienceMapper::test_lists_conversion PASSED [ 50%]
api/tests/experiences/test_models.py::TestExperienceModels::test_experience_creation PASSED [ 54%]
api/tests/experiences/test_models.py::TestExperienceModels::test_experience_to_dict PASSED [ 58%]
api/tests/experiences/test_models.py::TestExperienceModels::test_experience_from_dict PASSED [ 62%]
api/tests/experiences/test_models.py::TestExperienceModels::test_experience_from_dict_error_r2 PASSED [ 66%]
api/tests/experiences/test_serializers.py::TestExperienceSerializers::test_experience_create_serializer_valid PASSED [ 70%]
api/tests/experiences/test_serializers.py::TestExperienceSerializers::test_experience_update_serializer_valid PASSED [ 75%]
api/tests/experiences/test_serializers.py::TestExperienceSerializers::test_experience_response_serializer_valid FAILED [ 79%]
api/tests/experiences/test_serializers.py::TestExperienceSerializers::test_experience_list_response_serializer_valid PASSED [ 83%]
api/tests/experiences/test_views.py::TestExperienceViews::test_get_experiences_list_success PASSED [ 87%]
api/tests/experiences/test_views.py::TestExperienceViews::test_create_experience_success PASSED [ 91%]
api/tests/experiences/test_views.py::TestExperienceViews::test_patch_experience_success FAILED [ 95%]
api/tests/experiences/test_views.py::TestExperienceViews::test_delete_experience_success PASSED [100%]

================================== FAILURES ===================================
______________ TestExperienceDAO.test_delete_experience_success _______________
C:\Users\jordi\AppData\Local\Programs\Python\Python313\Lib\unittest\mock.py:946: in assert_called
    raise AssertionError(msg)
E   AssertionError: Expected 'delete_pattern' to have been called.

During handling of the above exception, another exception occurred:
api\tests\experiences\test_daos.py:118: in test_delete_experience_success
    mock_cache.delete_pattern.assert_called()
E   AssertionError: Expected 'delete_pattern' to have been called.
---------------------------- Captured stderr call -----------------------------
2025-12-29 00:15:38,292 [DAO] api.daos.experience_dao: Firestore READ: collection=experiences document=exp_123
2025-12-29 00:15:38,295 [DAO] api.daos.experience_dao: Firestore DELETE: collection=experiences document=exp_123
_____ TestExperienceSerializers.test_experience_response_serializer_valid _____
api\tests\experiences\test_serializers.py:49: in test_experience_response_serializer_valid
    assert serializer.is_valid()
E   AssertionError: assert False
E    +  where False = <bound method BaseSerializer.is_valid of ExperienceResponseSerializer(data={'id': 'exp_1', 'refuge_id': 'ref_1', 'creator_uid': 'user_1', 'modified_at': '2024-01-01', 'comment': 'Test', 'images_metadata': [{'key': 'key1', 'url': 'http://url1', 'uploaded_at': '2024-01-01', 'creator_uid': 'user_1'}]}):\n    id = CharField()\n    refuge_id = CharField()\n    creator_uid = CharField()\n    modified_at = CharField()\n    comment = CharField()\n    images_metadata = RefugeMediaMetadataSerializer(many=True, required=False):\n        key = CharField()\n        url = URLField()\n        creator_uid = CharField(allow_null=True, required=False)\n        uploaded_at = CharField(allow_null=True, required=False)\n        experience_id = CharField(allow_null=True, required=False)>()
E    +    where <bound method BaseSerializer.is_valid of ExperienceResponseSerializer(data={'id': 'exp_1', 'refuge_id': 'ref_1', 'creator_uid': 'user_1', 'modified_at': '2024-01-01', 'comment': 'Test', 'images_metadata': [{'key': 'key1', 'url': 'http://url1', 'uploaded_at': '2024-01-01', 'creator_uid': 'user_1'}]}):\n    id = CharField()\n    refuge_id = CharField()\n    creator_uid = CharField()\n    modified_at = CharField()\n    comment = CharField()\n    images_metadata = RefugeMediaMetadataSerializer(many=True, required=False):\n        key = CharField()\n        url = URLField()\n        creator_uid = CharField(allow_null=True, required=False)\n        uploaded_at = CharField(allow_null=True, required=False)\n        experience_id = CharField(allow_null=True, required=False)> = ExperienceResponseSerializer(data={'id': 'exp_1', 'refuge_id': 'ref_1', 'creator_uid': 'user_1', 'modified_at': '2024-01-01', 'comment': 'Test', 'images_metadata': [{'key': 'key1', 'url': 'http://url1', 'uploaded_at': '2024-01-01', 'creator_uid': 'user_1'}]}):\n    id = CharField()\n    refuge_id = CharField()\n    creator_uid = CharField()\n    modified_at = CharField()\n    comment = CharField()\n    images_metadata = RefugeMediaMetadataSerializer(many=True, required=False):\n        key = CharField()\n        url = URLField()\n        creator_uid = CharField(allow_null=True, required=False)\n        uploaded_at = CharField(allow_null=True, required=False)\n        experience_id = CharField(allow_null=True, required=False).is_valid
______________ TestExperienceViews.test_patch_experience_success ______________
api\tests\experiences\test_views.py:87: in test_patch_experience_success
    assert response.status_code == status.HTTP_200_OK
E   assert 500 == 200
E    +  where 500 = <Response status_code=500, "text/html; charset=utf-8">.status_code
E    +  and   200 = status.HTTP_200_OK
---------------------------- Captured stderr call -----------------------------
2025-12-29 00:15:38,619 [ERROR] api.views.experience_views: Error actualitzant experi?ncia: "Got KeyError when attempting to get a value for field `refuge_id` on serializer `ExperienceResponseSerializer`.\nThe serializer field might be named incorrectly and not match any attribute or key on the `dict` instance.\nOriginal exception text was: 'refuge_id'."
=========================== short test summary info ===========================
FAILED api/tests/experiences/test_daos.py::TestExperienceDAO::test_delete_experience_success
FAILED api/tests/experiences/test_serializers.py::TestExperienceSerializers::test_experience_response_serializer_valid
FAILED api/tests/experiences/test_views.py::TestExperienceViews::test_patch_experience_success
======================== 3 failed, 21 passed in 0.73s =========================
